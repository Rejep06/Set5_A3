## Почему код выбора B именно такой

В HLL **B влияет сразу на 3 вещи**, и код проверяет каждую:

### 1) Равномерность “субпотоков” по первым B битам
Мы делаем `j = topBbits(hash)` и считаем `cnt[j]`.  
Если хеш равномерный, то `cnt[j]` должны быть близки к `N/m`.

- `mu = N/m` сколько элементов в среднем на регистр.
- `cv = stdev(cnt)/mu` насколько сильно регистры отличаются по заполнению.
- `min/max` быстро показывает перекосы.

**Почему это важно:** если регистры заполняются неравномерно, HLL начинает хуже оценивать и растёт дисперсия.

### 2) “Распределение оставшихся L−B бит по субпотокам”
Оставшиеся `32-B` бит используются через `rho(w)` .  
Если эти хвостовые биты ведут себя случайно и **не коррелируют с j**, то среднее `rho` в каждом регистре должно быть примерно одинаковым.

Поэтому код считает:
- `rho_avg[j]` среднее `rho` внутри регистра
- `rho_sd_reg` разброс этих средних между регистрами

**Почему это важно:** если `rho` зависит от `j`, то часть регистров будет систематически завышать/занижать вклад -> ошибка и смещение.

### 3) Реальная точность (относительная ошибка)
Даже если распределения “вроде ок”, B может быть слишком большим (слишком мало элементов на регистр) -> пустые регистры -> хуже точность.  
Поэтому код считает `rel_error` на потоке.

### Почему есть порог `mu >= 20`
Если `mu=N/m` слишком маленькое, многие регистры почти пустые.  
В этом режиме:
- `cnt[j]` имеют высокий разброс неизбежно,
- `rho_avg[j]` становится нестабильным

Поэтому код отбрасывает B, где регистры слишком пустые, и выбирает разумный компромисс.


# Этап 3. Анализ результатов стандартного HyperLogLog (B = 9)

Ниже приведён анализ практических результатов работы HyperLogLog и сравнение с теоретическими оценками.  
Используются файлы:

- `graph1.csv`: `prefix_len, exact, estimate` (один поток)
- `graph2.csv`: `prefix_len, mean_est, std_est, upper, lower` (статистика по нескольким потокам)

Параметр алгоритма: **B = 9**, значит число регистров:

- \( m = 2^B = 2^9 = 512 \)

---

## 1) Точность и сравнение с теорией (1.04/√m и 1.32/√m)

Теоретическая относительная стандартная ошибка (RSE) HyperLogLog:

\[
RSE_{\text{theory}} \approx \frac{1.04}{\sqrt{m}}
\]

и более консервативная оценка:

\[
RSE_{\text{cons}} \approx \frac{1.32}{\sqrt{m}}
\]

Для \(m=512\):

- \(\sqrt{512} \approx 22.627\)
- \(\frac{1.04}{\sqrt{512}} \approx 0.04596\) (≈ **4.60%**)
- \(\frac{1.32}{\sqrt{512}} \approx 0.05834\) (≈ **5.83%**)

### Практическая оценка RSE

По `graph2.csv` у нас есть стандартное отклонение оценок \( \sigma(N_t) \) (`std_est`) и точное значение \(F_0^t\) (`exact` из `graph1.csv`).  
Практическую относительную стандартную ошибку считаем как:

\[
\widehat{RSE}(t) = \frac{\sigma(N_t)}{F_0^t} = \frac{std\_est(t)}{exact(t)}
\]

Результаты (по данным):

| prefix_len | exact | std_est | RSE_hat = std_est / exact |
|---:|---:|---:|---:|
| 30000  | 28948  | 1299.08  | 0.0449 |
| 60000  | 57653  | 2644.31  | 0.0459 |
| 90000  | 86209  | 4510.49  | 0.0523 |
| 120000 | 114603 | 5708.27  | 0.0498 |
| 150000 | 142817 | 7387.09  | 0.0517 |
| 180000 | 171051 | 7590.17  | 0.0444 |
| 210000 | 199229 | 8855.20  | 0.0444 |
| 239999 | 227357 | 9230.92  | 0.0406 |
| 270000 | 255463 | 11027.6  | 0.0432 |
| 300000 | 283524 | 12425.3  | 0.0438 |

Статистика по всем точкам:
- Среднее значение \(\widehat{RSE}\) ≈ **0.0459**
- Минимум ≈ **0.0406**
- Максимум ≈ **0.0523**

### Вывод по точности

- Средняя практическая \(\widehat{RSE}\) (**≈ 0.0459**) практически совпадает с теоретической \(\frac{1.04}{\sqrt{512}}\) (**≈ 0.0460**).
- Во всех моментах времени \(\widehat{RSE}(t)\) **не превышает** \(\frac{1.32}{\sqrt{512}}\) (**≈ 0.0583**).
- Небольшие колебания вокруг теоретической линии (например, рост до ~0.052 на некоторых t) являются нормальными для конечного числа запусков/потоков и переходных режимов.

Итого: **практическая точность соответствует теории** и укладывается в рамки оценок \(1.04/\sqrt{m}\) и \(1.32/\sqrt{m}\).

---

## 2) Стабильность оценки (дисперсия)

Стабильность характеризуется дисперсией/стандартным отклонением оценок \(N_t\) между разными потоками:

- абсолютное \(\sigma(N_t)\) (`std_est`) растёт с ростом количества уникальных элементов (что естественно),
- при этом относительный разброс \(\sigma(N_t)/F_0^t\) держится примерно на уровне **4–5%** и стабилизируется около величины \(\approx 1.04/\sqrt{m}\).

Это означает, что оценка **стабильна** и её разброс хорошо соответствует теоретической модели HLL для \(m=512\).

---

## 3) Эффективность констант и влияние параметров

### 3.1 Влияние B (числа регистров m=2^B)
Параметр `B` задаёт компромисс:

- увеличение `B` -> увеличение `m` -> снижение теоретической ошибки как \( \sim 1/\sqrt{m} \),
- но увеличение `m` увеличивает память и при фиксированном размере потока уменьшает среднее число элементов на регистр \( \mu = N/m \), что может увеличивать шум при слишком больших `B`.

В данном эксперименте при **B=9**:
- \(m=512\),
- теоретическая RSE ≈ 4.6%,
- практическая RSE ≈ 4.6% (почти совпало).

Это говорит, что `B=9` даёт корректный баланс точности и устойчивости для выбранных размеров потоков.

### 3.2 Константа αm (нормировка HyperLogLog)
В стандартном HLL используется коэффициент \(\alpha_m\) (зависит от m).  
Он влияет на **смещение** оценки (bias). Корректный выбор \(\alpha_m\) уменьшает систематическое завышение/занижение.

### 3.3 Small-range correction (LinearCounting)
Для малых кардинальностей (обычно когда оценка \(E \le 2.5m\)) применяется LinearCounting.  
Эта коррекция улучшает точность на ранних шагах, когда ещё много нулевых регистров.

В нашем случае на начальных t значения также показывают адекватное поведение и не выбиваются из ожидаемой относительной погрешности.

---

## 4) Дополнительное замечание: смещение (bias)

По данным `graph1.csv` и `graph2.csv` средняя оценка `mean_est` на большинстве шагов слегка **занижает** истинное значение (обычно на ~0.6–1.6%).  
Небольшое смещение возможно из-за конечных размеров потоков, особенностей хеширования и переходных режимов. При этом основная характеристика (разброс/RSE) соответствует теории.

---

## Итог

Для параметра **B = 9 (m = 512)**:

- практическая относительная ошибка \(\widehat{RSE}\) близка к теоретической \(1.04/\sqrt{m}\),
- значения укладываются в консервативную границу \(1.32/\sqrt{m}\),
- оценка стабильна: относительная дисперсия держится около 4–5%,
- выбранные константы (αm, LinearCounting) обеспечивают корректную работу алгоритма в разных режимах потока.

